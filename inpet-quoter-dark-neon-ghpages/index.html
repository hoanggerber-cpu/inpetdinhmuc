<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>IN PET • Báo giá Pro — Dark Neon</title>
  <meta name="color-scheme" content="dark">
  <meta name="description" content="IN PET • Báo giá Pro. Ứng dụng tạo, lưu và xuất báo giá in PET. Dark Neon UI.">
  <style>
    :root{
      --bg:#0b0f14; --bg-2:#0e1218; --panel:#111827; --line:#1f2937;
      --text:#e5f2ff; --sub:#a9b7c6; --muted:#7a8896;
      --neon:#41ffd0; --neon-2:#00d1ff; --danger:#ff5a67;
      --radius:18px; --shadow:0 18px 40px rgba(0,0,0,.35), 0 0 0 1px rgba(65,255,208,.06) inset;
      --font:-apple-system,system-ui,Segoe UI,Roboto,Inter,Helvetica,Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:radial-gradient(1200px 800px at 10% -10%, rgba(0,209,255,.06), transparent 50%),
                 radial-gradient(900px 600px at 110% 10%, rgba(65,255,208,.06), transparent 60%),
                 var(--bg);
      color:var(--text); font-family:var(--font);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    a{color:var(--neon)}
    .app{display:grid; grid-template-columns: 360px 1fr; min-height:100vh}
    @media (max-width: 1024px){ .app{grid-template-columns: 1fr} }

    .hdr{position:sticky; top:0; z-index:10; backdrop-filter:saturate(160%) blur(10px);
      background:linear-gradient(180deg, rgba(10,14,18,.85), rgba(10,14,18,.6)); border-bottom:1px solid var(--line);
      box-shadow:0 1px 0 rgba(65,255,208,.12) inset}
    .wrap{max-width:1240px; margin:0 auto; padding:14px 18px}
    .title{font-weight:800; letter-spacing:.2px; font-size:20px}
    .subtitle{color:var(--muted); font-size:13px}

    .seg{display:inline-flex;border-radius:14px;overflow:hidden;border:1px solid var(--line); background:rgba(255,255,255,.02)}
    .seg button{color:var(--sub); background:transparent; border:0; padding:.5rem .9rem; cursor:pointer}
    .seg button.active{color:#081114; background:linear-gradient(90deg, var(--neon), var(--neon-2));
      box-shadow:0 0 22px rgba(65,255,208,.45), 0 0 1px rgba(0,209,255,.65) inset; font-weight:700}

    .sidebar{border-right:1px solid var(--line); background:linear-gradient(180deg, rgba(0,0,0,.18), rgba(0,0,0,.05)); min-height:calc(100vh - 60px)}
    .search,.input,.textarea, select{width:100%; padding:.7rem .9rem; border-radius:12px; border:1px solid var(--line); background:rgba(255,255,255,.02);
      color:var(--text); outline:none}
    .search:focus,.input:focus,.textarea:focus, select:focus{ border-color:var(--neon); box-shadow:0 0 0 3px rgba(65,255,208,.18) }
    .order{padding:12px; border:1px solid var(--line); border-radius:14px; background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
      cursor:pointer; transition:.2s}
    .order:hover{ transform:translateY(-1px); box-shadow:0 8px 26px rgba(0,0,0,.3) }
    .order.active{ outline:2px solid rgba(65,255,208,.55); box-shadow:0 0 0 2px rgba(65,255,208,.2) inset }

    .card{background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015)); border:1px solid var(--line);
      border-radius:var(--radius); box-shadow:var(--shadow); padding:16px}
    .panel{background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01)); border:1px solid var(--line);
      border-radius:var(--radius); padding:14px}

    .btn{display:inline-flex;align-items:center;gap:.55rem;padding:.6rem .95rem;border-radius:12px;border:1px solid var(--line);background:rgba(255,255,255,.02);color:var(--text);cursor:pointer}
    .btn:hover{box-shadow:0 0 0 2px rgba(255,255,255,.05) inset}
    .primary{background:linear-gradient(90deg, var(--neon), var(--neon-2)); color:#081114; border-color:transparent; font-weight:700;
      box-shadow:0 0 24px rgba(65,255,208,.35), 0 0 1px rgba(0,209,255,.6) inset}
    .danger{ border-color:rgba(255,90,103,.6); color:#ffd4d8; background:rgba(255,90,103,.06) }
    .ghost{background:transparent}

    .grid{display:grid;gap:12px}
    .g2{grid-template-columns:1fr 1fr}
    @media (max-width: 720px){ .g2{grid-template-columns:1fr} }

    table{width:100%;border-collapse:separate;border-spacing:0;overflow:hidden;border-radius:14px;border:1px solid var(--line);background:rgba(255,255,255,.01)}
    thead{background:linear-gradient(180deg, rgba(0,209,255,.08), rgba(65,255,208,.06)); color:#dffcff}
    th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left}
    tbody tr:last-child td{border-bottom:0}
    tbody tr:hover{ background:rgba(65,255,208,.05) }

    .thumbs{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px}
    .thumb{border:1px solid var(--line);border-radius:14px;overflow:hidden;background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01))}
    .thumb img{width:100%;display:block;object-fit:contain;height:140px;background:#0a0f14}
    .thumb .bar{display:flex;gap:6px;padding:8px;align-items:center;justify-content:space-between}

    .sub{color:var(--sub)}
    .muted{color:var(--muted); font-size:12px}
    .kpi{font-weight:800; font-size:22px; letter-spacing:.2px}

    .toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:rgba(0,0,0,.75);color:var(--text);
      padding:.6rem .9rem;border-radius:12px;opacity:0;transition:.25s;z-index:50;border:1px solid var(--line);
      box-shadow:0 0 20px rgba(65,255,208,.25)}
    .toast.show{opacity:1; transform:translate(-50%,-6px)}

    .divider{height:1px; background:linear-gradient(90deg, transparent, rgba(65,255,208,.35), transparent); margin:8px 0}
  </style>
  <!-- Optional libs for export; app vẫn chạy nếu không có mạng -->
  <script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body>
  <header class="hdr">
    <div class="wrap" style="display:flex;align-items:center;justify-content:space-between;gap:12px">
      <div>
        <div class="title">IN PET • Báo giá Pro</div>
        <div class="subtitle">Dark + Neon • High-tech style • CRUD + ảnh + export</div>
      </div>
      <div class="seg">
        <button class="active" data-tab="editor">Soạn báo giá</button>
        <button data-tab="files">Tệp đã tạo</button>
        <button data-tab="stats">Thống kê</button>
      </div>
    </div>
  </header>

  <div class="app">
    <aside class="sidebar">
      <div class="wrap" style="padding-top:12px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div class="sub">Đơn báo giá</div>
          <button id="btnNewOrder" class="btn primary">+ Tạo đơn</button>
        </div>
        <input id="searchOrders" class="search" placeholder="Tìm KH / mã hàng...">
        <div style="display:flex;gap:8px;margin-top:8px">
          <select id="sortOrders" class="input" style="flex:1">
            <option value="updatedAt">Mới cập nhật</option>
            <option value="createdAt">Mới tạo</option>
            <option value="customer">Tên KH (A→Z)</option>
            <option value="totalDesc">Tổng tiền (↓)</option>
          </select>
          <button id="btnExportAll" class="btn">Xuất</button>
          <label class="btn">Nhập <input id="importJson" type="file" accept="application/json" class="hidden" style="display:none"></label>
        </div>
        <div id="orderList" style="margin-top:10px; display:grid; gap:10px; max-height: calc(100vh - 230px); overflow:auto;"></div>
      </div>
    </aside>

    <main>
      <div class="wrap" style="padding-top:12px; display:grid; gap:14px;">
        <div class="card" style="display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between">
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="btnSave" class="btn primary">Lưu đơn</button>
            <button id="btnDuplicateOrder" class="btn">Nhân bản</button>
            <button id="btnDeleteOrder" class="btn danger">Xoá</button>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="btnExportPNG" class="btn primary">Tải PNG</button>
            <button id="btnExportPDF" class="btn">Tải PDF</button>
          </div>
        </div>

        <section id="tab-editor" class="grid g2">
          <div class="card">
            <div class="sub" style="margin-bottom:8px">Khách hàng & Thiết lập</div>
            <div class="grid g2">
              <div><label class="sub">Tên KH</label><input id="customer" class="input"></div>
              <div><label class="sub">Mã KH</label><input id="customerCode" class="input"></div>
              <div><label class="sub">Mã hàng in</label><input id="productCode" class="input"></div>
              <div><label class="sub">Đơn giá /1 mét (VND)</label><input id="unitPrice" class="input" inputmode="decimal" placeholder="vd 45000"></div>
              <div><label class="sub">Phí thiết kế</label><input id="designFee" class="input" inputmode="decimal" value="0"></div>
              <div><label class="sub">Phí vận chuyển</label><input id="shippingFee" class="input" inputmode="decimal" value="0"></div>
            </div>
            <label class="sub" style="margin-top:8px;display:block">Ghi chú</label>
            <textarea id="note" class="textarea"></textarea>
            <div style="margin-top:8px">
              <label class="sub">Trạng thái</label>
              <select id="label" class="input">
                <option value="new">Mới</option>
                <option value="inprogress">Đang làm</option>
                <option value="done">Hoàn tất</option>
              </select>
            </div>

            <div class="divider"></div>
            <div>
              <div class="sub" style="margin-bottom:6px">Ảnh đính kèm đơn hàng</div>
              <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px">
                <label class="btn">+ Thêm ảnh<input id="orderImages" type="file" accept="image/*" multiple class="hidden" style="display:none"></label>
                <button id="btnClearImages" class="btn">Xoá toàn bộ ảnh</button>
              </div>
              <div id="imageGrid" class="thumbs"></div>
            </div>
          </div>

          <div class="card">
            <div class="sub" style="margin-bottom:8px">Chi tiết layout</div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
              <button id="btnAddPresetNhi" class="btn">+ Nhí 8cm (16/0.31m)</button>
              <button id="btnAddPresetDai" class="btn">+ Đại 9cm (13/0.39m)</button>
              <button id="btnAddRow" class="btn">+ Thêm hàng</button>
            </div>
            <div class="panel">
              <table>
                <thead>
                  <tr>
                    <th>Tên</th>
                    <th>Nhóm</th>
                    <th>Màu</th>
                    <th>m/1 lần</th>
                    <th>hình/1 lần</th>
                    <th>Nhu cầu</th>
                    <th>Lần in</th>
                    <th>Tổng m</th>
                    <th>Tiền</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="rows"></tbody>
              </table>
            </div>
          </div>

          <div class="card" style="grid-column:1 / -1">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
              <div class="sub">Bản in báo giá</div>
              <div class="muted">Ngày: <span id="today"></span> • Mã: <span id="pcode"></span></div>
            </div>
            <div id="printArea" class="panel">
              <div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:8px">
                <div>
                  <div style="font-weight:800; letter-spacing:.2px">Báo giá In PET</div>
                  <div id="headerLine" class="muted"></div>
                </div>
              </div>
              <table>
                <thead>
                  <tr>
                    <th>Tên</th>
                    <th>Nhóm</th>
                    <th>m/1 lần</th>
                    <th>hình/1 lần</th>
                    <th>Nhu cầu</th>
                    <th>Lần in</th>
                    <th>Tổng m</th>
                    <th style="text-align:right">Thành tiền</th>
                  </tr>
                </thead>
                <tbody id="printRows"></tbody>
              </table>
              <div class="grid g2" style="margin-top:8px">
                <div class="panel">
                  <div>Tổng lần in: <b id="tRuns">0</b></div>
                  <div>Tổng mét: <b id="tMeters">0</b> m</div>
                  <div>Tổng nhu cầu: <b id="tDemand">0</b> hình</div>
                </div>
                <div class="panel">
                  <div>Nhóm Nhí: <b id="gNhiMeters">0</b> m</div>
                  <div>Nhóm Đại: <b id="gDaiMeters">0</b> m</div>
                </div>
                <div class="panel">
                  <div>Tạm tính: <b id="tSubtotal">0</b> đ</div>
                  <div>Phí thiết kế: <b id="tDesign">0</b> đ</div>
                  <div>Phí vận chuyển: <b id="tShip">0</b> đ</div>
                  <div style="font-size:18px;margin-top:4px">Tổng cộng: <b id="tTotal">0 đ</b></div>
                </div>
              </div>
              <div class="muted" style="margin-top:6px">Ghi chú: <span id="tNote"></span></div>

              <div id="printImagesWrap" style="margin-top:10px">
                <div class="sub" style="margin-bottom:6px">Ảnh đính kèm:</div>
                <div id="printImages" class="thumbs"></div>
              </div>
            </div>
          </div>
        </section>

        <section id="tab-files" class="card" style="display:none">
          <div class="sub" style="margin-bottom:8px">Tệp đã tạo cho đơn này</div>
          <div id="fileList" class="grid" style="grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px"></div>
        </section>

        <section id="tab-stats" class="card" style="display:none">
          <div class="sub" style="margin-bottom:8px">Thống kê tổng hợp</div>
          <div id="statsBox" class="grid" style="grid-template-columns:repeat(auto-fit,minmax(210px,1fr));gap:10px"></div>
        </section>
      </div>
    </main>
  </div>

  <template id="rowTpl">
    <tr>
      <td><input class="input name" placeholder="Tên layout"></td>
      <td>
        <select class="input group">
          <option value="nhi">Nhí</option>
          <option value="dai">Đại</option>
          <option value="khac">Khác</option>
        </select>
      </td>
      <td><input class="input color" placeholder="vd Hồng sen"></td>
      <td><input class="input mper" inputmode="decimal" placeholder="0.31"></td>
      <td><input class="input ipr" inputmode="decimal" placeholder="16"></td>
      <td><input class="input demand" inputmode="decimal" placeholder="600"></td>
      <td class="runs" style="text-align:center">0</td>
      <td class="meters" style="text-align:center">0</td>
      <td class="money" style="text-align:right">0</td>
      <td><button class="btn" style="padding:.35rem .6rem">X</button></td>
    </tr>
  </template>

  <div id="toast" class="toast">Đã lưu đơn</div>

  <script>
  (function(){
    const fmt = new Intl.NumberFormat('vi-VN');
    const KEY = 'inpet_quoter_orders_v2_neon';
    const filesKey = (id)=> 'inpet_files_neon_'+id;
    let state = {orders:[], activeId:null};

    const el = (s,r=document)=>r.querySelector(s);
    const els = (s,r=document)=>Array.from(r.querySelectorAll(s));
    const uid = ()=> Math.random().toString(36).slice(2) + Date.now().toString(36);
    const nowISO = ()=> new Date().toISOString();
    const parseNum = (v)=>{ if(typeof v==='number') return v; if(!v) return 0; v=String(v).replace(',','.'); const n=parseFloat(v); return isNaN(n)?0:n; };

    function toast(msg='Đã lưu đơn'){
      const t = el('#toast');
      t.textContent = msg; t.classList.add('show');
      setTimeout(()=> t.classList.remove('show'), 1200);
    }

    function save(manual=false){
      localStorage.setItem(KEY, JSON.stringify({orders: state.orders, activeId: state.activeId}));
      if (manual) toast('Đã lưu đơn');
    }
    function load(){
      try{
        const obj = JSON.parse(localStorage.getItem(KEY)||'null');
        if (obj){ state.orders = obj.orders||[]; state.activeId = obj.activeId||state.orders[0]?.id||null; }
      }catch{}
    }
    function activeOrder(){ return state.orders.find(o=>o.id===state.activeId)||null }
    function touch(o){ o.updatedAt = nowISO(); save(false); renderOrderList(); }

    function fget(id){ try{ return JSON.parse(localStorage.getItem(filesKey(id))||'[]') }catch{ return [] } }
    function fset(id, arr){ localStorage.setItem(filesKey(id), JSON.stringify(arr)) }

    els('.seg button').forEach(b=> b.addEventListener('click', ()=>{
      els('.seg button').forEach(x=>x.classList.remove('active')); b.classList.add('active');
      const t = b.dataset.tab;
      el('#tab-editor').style.display = (t==='editor')?'grid':'none';
      el('#tab-files').style.display = (t==='files')?'block':'none';
      el('#tab-stats').style.display = (t==='stats')?'block':'none';
      if (t==='files') renderFiles();
      if (t==='stats') renderStats();
    }));

    function newOrder(){
      const id = uid();
      const order = {
        id, createdAt: nowISO(), updatedAt: nowISO(),
        data: {customer:'', customerCode:'', productCode:'', unitPrice:0, designFee:0, shippingFee:0, note:'', label:'new', rows:[], images:[]},
        totals: {}
      };
      state.orders.unshift(order);
      state.activeId = id;
      save(false); renderOrderList(); bindOrder(order);
    }
    function duplicateOrder(){
      const o = activeOrder(); if(!o) return;
      const copy = JSON.parse(JSON.stringify(o));
      copy.id = uid(); copy.createdAt = nowISO(); copy.updatedAt = nowISO();
      state.orders.unshift(copy); state.activeId = copy.id;
      save(false); renderOrderList(); bindOrder(copy);
    }
    function deleteOrder(){
      const o = activeOrder(); if(!o) return;
      if (!confirm('Xoá đơn này?')) return;
      localStorage.removeItem(filesKey(o.id));
      state.orders = state.orders.filter(x=>x.id!==o.id);
      state.activeId = state.orders[0]?.id||null;
      save(true); renderOrderList(); bindOrder(activeOrder());
    }
    function renderOrderList(){
      const list = el('#orderList'); list.innerHTML='';
      const q = el('#searchOrders').value.trim().toLowerCase();
      const sort = el('#sortOrders').value;
      let arr = [...state.orders];
      if (q){ arr = arr.filter(o=> (o.data.customer+o.data.customerCode+o.data.productCode).toLowerCase().includes(q)); }
      arr.forEach(o => { if (!o.totals || !('total' in o.totals)) o.totals = calcTotals(o.data); });
      if (sort==='updatedAt') arr.sort((a,b)=> b.updatedAt.localeCompare(a.updatedAt));
      else if (sort==='createdAt') arr.sort((a,b)=> b.createdAt.localeCompare(a.createdAt));
      else if (sort==='customer') arr.sort((a,b)=> (a.data.customer||'').localeCompare(b.data.customer||''));
      else if (sort==='totalDesc') arr.sort((a,b)=> (b.totals.total||0) - (a.totals.total||0));

      for (const o of arr){
        const card = document.createElement('div');
        card.className = 'order';
        card.innerHTML = `
          <div style="display:flex;justify-content:space-between;gap:8px">
            <div>
              <div style="font-weight:700">${o.data.customer || '(Chưa đặt tên)'}</div>
              <div class="sub">${o.data.productCode || ''}</div>
              <div class="sub">Tổng: <b style="color:var(--neon)">${Intl.NumberFormat('vi-VN').format(Math.round(o.totals.total||0))}</b> đ</div>
            </div>
            <div class="sub" style="text-align:right">${new Date(o.updatedAt).toLocaleString('vi-VN')}</div>
          </div>
        `;
        card.addEventListener('click', ()=>{
          state.activeId = o.id; save(false); bindOrder(o);
          els('.order').forEach(n=>n.classList.remove('active')); card.classList.add('active');
        });
        if (o.id===state.activeId) card.classList.add('active');
        list.appendChild(card);
      }
    }

    function bindOrder(o){
      if (!o){ el('#rows').innerHTML=''; el('#imageGrid').innerHTML=''; return; }
      el('#today').textContent = new Date().toLocaleDateString('vi-VN');
      el('#pcode').textContent = o.data.productCode||'';
      el('#customer').value = o.data.customer||'';
      el('#customerCode').value = o.data.customerCode||'';
      el('#productCode').value = o.data.productCode||'';
      el('#unitPrice').value = o.data.unitPrice||'';
      el('#designFee').value = o.data.designFee||0;
      el('#shippingFee').value = o.data.shippingFee||0;
      el('#note').value = o.data.note||'';
      el('#label').value = o.data.label||'new';
      el('#headerLine').textContent = (o.data.customer||'') + ' • Mã KH: ' + (o.data.customerCode||'');
      el('#tNote').textContent = o.data.note||'';

      const tbody = el('#rows'); tbody.innerHTML='';
      (o.data.rows||[]).forEach(r=> addRowUI(r));
      renderImages();
      recalcAndRender();
      renderFiles();
    }

    function addRowUI(r=null){
      const tpl = el('#rowTpl').content.cloneNode(true);
      const tr = tpl.querySelector('tr');
      const name = tr.querySelector('.name');
      const group = tr.querySelector('.group');
      const color = tr.querySelector('.color');
      const mper = tr.querySelector('.mper');
      const ipr = tr.querySelector('.ipr');
      const demand = tr.querySelector('.demand');
      const btnDel = tr.querySelector('.btn');

      name.value = r?.name||'';
      group.value = r?.group||'nhi';
      color.value = r?.color||'';
      mper.value = r?.mper??'';
      ipr.value = r?.ipr??'';
      demand.value = r?.demand??'';

      const onChange = ()=>{
        const o = activeOrder(); if (!o) return;
        const idx = Array.from(tr.parentElement.children).indexOf(tr);
        const row = o.data.rows[idx] || {};
        row.name = name.value;
        row.group = group.value;
        row.color = color.value;
        row.mper = parseNum(mper.value);
        row.ipr = parseNum(ipr.value);
        row.demand = parseNum(demand.value);
        o.data.rows[idx] = row;
        touch(o); recalcAndRender();
      };
      [name,group,color,mper,ipr,demand].forEach(inp=> inp.addEventListener('input', onChange));

      btnDel.addEventListener('click', ()=>{
        const o = activeOrder(); if (!o) return;
        const idx = Array.from(tr.parentElement.children).indexOf(tr);
        o.data.rows.splice(idx,1);
        tr.remove(); touch(o); recalcAndRender();
      });

      el('#rows').appendChild(tr);
    }

    function calcTotals(data){
      const unit = parseNum(data.unitPrice||0);
      const rows = []; let totalRuns=0,totalMeters=0,totalDemand=0,subtotal=0;
      const groupMeters = {nhi:0,dai:0,khac:0};
      for (const r of data.rows||[]){
        const mper = parseNum(r.mper), ipr=parseNum(r.ipr), demand=parseNum(r.demand);
        const runs = ipr>0 ? Math.ceil(demand/ipr) : 0;
        const meters = runs * mper;
        const money = meters * unit;
        rows.push({name:r.name||'', group:r.group||'khac', mper, ipr, demand, runs, meters, money});
        totalRuns+=runs; totalMeters+=meters; totalDemand+=demand; subtotal+=money;
        groupMeters[r.group||'khac'] = (groupMeters[r.group||'khac']||0) + meters;
      }
      const total = subtotal + parseNum(data.designFee||0) + parseNum(data.shippingFee||0);
      return {rows,totalRuns,totalMeters,totalDemand,subtotal,groupMeters,total};
    }

    function recalcAndRender(){
      const o = activeOrder(); if (!o) return;
      o.totals = calcTotals(o.data);
      const pr = el('#printRows'); pr.innerHTML='';
      o.totals.rows.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.name}</td>
          <td>${r.group}</td>
          <td style="text-align:center">${r.mper}</td>
          <td style="text-align:center">${r.ipr}</td>
          <td style="text-align:center">${r.demand}</td>
          <td style="text-align:center">${r.runs}</td>
          <td style="text-align:center">${r.meters.toFixed(2)}</td>
          <td style="text-align:right;color:var(--neon)">${fmt.format(Math.round(r.money))}</td>`;
        pr.appendChild(tr);
      });
      el('#tRuns').textContent = o.totals.totalRuns;
      el('#tMeters').textContent = o.totals.totalMeters.toFixed(2);
      el('#tDemand').textContent = o.totals.totalDemand;
      el('#gNhiMeters').textContent = (o.totals.groupMeters.nhi||0).toFixed(2);
      el('#gDaiMeters').textContent = (o.totals.groupMeters.dai||0).toFixed(2);
      el('#tSubtotal').textContent = fmt.format(Math.round(o.totals.subtotal));
      el('#tDesign').textContent = fmt.format(Math.round(activeOrder().data.designFee||0));
      el('#tShip').textContent = fmt.format(Math.round(activeOrder().data.shippingFee||0));
      el('#tTotal').textContent = fmt.format(Math.round(o.totals.total)) + ' đ';

      const wrap = el('#printImages'); wrap.innerHTML='';
      (o.data.images||[]).forEach(img=>{
        const d = document.createElement('div');
        d.className = 'thumb';
        d.innerHTML = `<img src="${img.dataUrl}" alt=""><div class="bar"><div class="sub" style="font-size:12px">${img.name||''}</div></div>`;
        wrap.appendChild(d);
      });
      el('#printImagesWrap').style.display = (o.data.images && o.data.images.length) ? 'block' : 'none';
    }

    el('#orderImages').addEventListener('change', async (e)=>{
      const o = activeOrder(); if(!o) return;
      const files = Array.from(e.target.files||[]);
      for (const f of files){
        const dataUrl = await fileToDataURL(f);
        o.data.images.push({id: uid(), name: f.name, dataUrl});
      }
      touch(o); renderImages(); recalcAndRender();
      e.target.value = '';
    });
    el('#btnClearImages').addEventListener('click', ()=>{
      const o = activeOrder(); if(!o) return;
      if (!o.data.images?.length) return;
      if (!confirm('Xoá toàn bộ ảnh đính kèm?')) return;
      o.data.images = []; touch(o); renderImages(); recalcAndRender();
    });

    function renderImages(){
      const o = activeOrder(); if(!o) return;
      const grid = el('#imageGrid'); grid.innerHTML='';
      (o.data.images||[]).forEach(img=>{
        const d = document.createElement('div');
        d.className = 'thumb';
        d.innerHTML = `
          <img src="${img.dataUrl}" alt="">
          <div class="bar">
            <input class="input" style="padding:.35rem .5rem" value="${img.name}">
            <button class="btn danger" style="padding:.35rem .5rem">X</button>
          </div>`;
        const input = d.querySelector('input');
        input.addEventListener('change', ()=>{ img.name = input.value; touch(o); recalcAndRender(); });
        d.querySelector('button').addEventListener('click', ()=>{
          o.data.images = o.data.images.filter(x=> x.id!==img.id);
          touch(o); renderImages(); recalcAndRender();
        });
        grid.appendChild(d);
      });
    }

    function fileToDataURL(file){
      return new Promise(res=>{
        const fr = new FileReader();
        fr.onload = ()=> res(fr.result);
        fr.readAsDataURL(file);
      });
    }

    el('#btnExportAll').addEventListener('click', ()=>{
      const dataStr = JSON.stringify({orders: state.orders}, null, 2);
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([dataStr], {type:'application/json'}));
      a.download = 'inpet-quotes-backup-with-images.json';
      a.click();
    });
    el('#importJson').addEventListener('change', async (e)=>{
      const f = e.target.files?.[0]; if (!f) return;
      try{
        const obj = JSON.parse(await f.text());
        if (!Array.isArray(obj.orders)) throw new Error('Sai định dạng');
        state.orders = obj.orders; state.activeId = state.orders[0]?.id||null;
        save(true); renderOrderList(); bindOrder(activeOrder());
      }catch(err){ alert('Không thể nhập: ' + err.message) }
    });

    async function exportPNG(){
      const area = el('#printArea');
      if (!window.html2canvas){ alert('Thiếu thư viện xuất PNG (html2canvas). Bạn vẫn dùng app bình thường, chỉ không xuất PNG được khi mất mạng.'); return; }
      const o = activeOrder(); if(!o) return;
      const canvas = await html2canvas(area, {backgroundColor:'#0b0f14', scale:2});
      const data = canvas.toDataURL('image/png');
      downloadData(data, `Bao-gia-${o.data.customer||'khach'}.png`);
      const arr = fget(o.id);
      arr.unshift({id:uid(), kind:'png', name:`Bao-gia-${o.data.customer||'khach'}.png`, createdAt:nowISO(), dataUrl:data});
      fset(o.id, arr.slice(0,50));
      renderFiles();
    }
    async function exportPDF(){
      if (!window.html2canvas || !(window.jspdf && window.jspdf.jsPDF)){ alert('Thiếu thư viện PDF (html2canvas + jsPDF). Bạn vẫn dùng app bình thường, chỉ không xuất PDF được khi mất mạng.'); return; }
      const o = activeOrder(); if(!o) return;
      const area = el('#printArea');
      const canvas = await html2canvas(area, {backgroundColor:'#0b0f14', scale:2});
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({unit:'pt', format:'a4'});
      const pageW = pdf.internal.pageSize.getWidth();
      const imgW = pageW - 48; const ratio = imgW / canvas.width; const imgH = canvas.height * ratio;
      pdf.addImage(canvas.toDataURL('image/jpeg',1), 'JPEG', 24, 24, imgW, imgH, undefined, 'FAST');
      const b = pdf.output('blob'); const url = URL.createObjectURL(b);
      downloadUrl(url, `Bao-gia-${o.data.customer||'khach'}.pdf`);
      const fr = new FileReader();
      fr.onload = ()=>{
        const arr = fget(o.id);
        arr.unshift({id:uid(), kind:'pdf', name:`Bao-gia-${o.data.customer||'khach'}.pdf`, createdAt:nowISO(), dataUrl:fr.result});
        fset(o.id, arr.slice(0,50)); renderFiles();
      };
      fr.readAsDataURL(b);
    }
    function downloadData(dataUrl, name){ const a=document.createElement('a'); a.href=dataUrl; a.download=name; a.click(); }
    function downloadUrl(url, name){ const a=document.createElement('a'); a.href=url; a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(url), 1000); }

    function renderFiles(){
      const o = activeOrder(); if(!o) return;
      const box = el('#fileList'); box.innerHTML='';
      const arr = fget(o.id);
      for (const f of arr){
        const card = document.createElement('div');
        card.className = 'panel';
        const thumb = f.kind==='png'
          ? `<img src="${f.dataUrl}" style="display:block;width:100%;height:160px;object-fit:contain;background:#0a0f14;border-radius:12px">`
          : `<div style="display:grid;place-items:center;width:100%;height:160px;background:#0a0f14;border-radius:12px;color:var(--neon)">PDF</div>`;
        card.innerHTML = `
          ${thumb}
          <div style="display:flex;gap:8px;margin-top:8px">
            <input class="input fname" value="${f.name}">
            <button class="btn danger del">Xoá</button>
            <a class="btn primary" download="${f.name}" href="${f.dataUrl}">Tải</a>
          </div>
          <div class="muted" style="margin-top:6px">${new Date(f.createdAt).toLocaleString('vi-VN')}</div>`;
        el('.del', card).addEventListener('click', ()=>{
          const list = fget(o.id).filter(x=> x.id!==f.id); fset(o.id, list); renderFiles();
        });
        el('.fname', card).addEventListener('change', (e)=>{
          const list = fget(o.id); const t = list.find(x=> x.id===f.id); if (t) t.name = e.target.value; fset(o.id, list);
        });
        box.appendChild(card);
      }
    }

    function renderStats(){
      const box = el('#statsBox'); box.innerHTML='';
      const stats = {
        count: state.orders.length,
        revenue: Math.round(state.orders.reduce((s,o)=> s + (o.totals?.total||0), 0)),
        meters: state.orders.reduce((s,o)=> s + (o.totals?.totalMeters||0), 0),
        runs: state.orders.reduce((s,o)=> s + (o.totals?.totalRuns||0), 0),
      };
      const items = [
        ['Số đơn', stats.count],
        ['Tổng tiền', Intl.NumberFormat('vi-VN').format(stats.revenue)+' đ'],
        ['Tổng mét', stats.meters.toFixed(2)+' m'],
        ['Tổng lần in', stats.runs]
      ];
      for (const [k,v] of items){
        const c = document.createElement('div');
        c.className = 'panel';
        c.innerHTML = `<div class="sub">${k}</div><div class="kpi" style="color:${k==='Tổng tiền'?'var(--neon)':'#e5f2ff'}">${v}</div>`;
        box.appendChild(c);
      }
    }

    el('#btnSave').addEventListener('click', ()=> save(true));
    el('#btnDuplicateOrder').addEventListener('click', duplicateOrder);
    el('#btnDeleteOrder').addEventListener('click', deleteOrder);
    el('#btnNewOrder').addEventListener('click', newOrder);
    el('#btnExportPNG').addEventListener('click', exportPNG);
    el('#btnExportPDF').addEventListener('click', exportPDF);
    el('#searchOrders').addEventListener('input', renderOrderList);
    el('#sortOrders').addEventListener('change', renderOrderList);

    ['customer','customerCode','productCode','unitPrice','designFee','shippingFee','note','label'].forEach(id=>{
      el('#'+id).addEventListener('input', ()=>{
        const o = activeOrder(); if (!o) return;
        const v = el('#'+id).value;
        if (['unitPrice','designFee','shippingFee'].includes(id)) o.data[id] = parseNum(v);
        else o.data[id] = v;
        if (id==='productCode') el('#pcode').textContent = v;
        if (id==='customer'||id==='customerCode') el('#headerLine').textContent = (o.data.customer||'') + ' • Mã KH: ' + (o.data.customerCode||'');
        if (id==='note') el('#tNote').textContent = v;
        touch(o); recalcAndRender();
      });
    });

    el('#btnAddPresetNhi').addEventListener('click', ()=> addRowUI({name:'Nhí 8cm', group:'nhi', color:'', mper:0.31, ipr:16, demand:0}));
    el('#btnAddPresetDai').addEventListener('click', ()=> addRowUI({name:'Đại 9cm', group:'dai', color:'', mper:0.39, ipr:13, demand:0}));
    el('#btnAddRow').addEventListener('click', ()=> addRowUI({group:'khac'}));

    load();
    if (!state.orders.length) newOrder(); else { renderOrderList(); bindOrder(activeOrder()); }
  })();
  </script>
</body>
</html>
